# 概述

- 主要功能是实现对**用户笔记的管理**。包括**用户登录模块**，**笔记显示模块**，**笔记编辑模块**和**笔记搜索模块**。
- **用户登录模块**的主要需求是，当用户名和密码输入框都有输入时，登录按钮变色和激活。用户点击登录后根据服务器返回的内容，使用气泡和标签提示用户。登陆成功则转入用户笔记显示页面。
- **笔记显示页面**的主要需求是，以列表的形式展示用户的所有笔记，笔记包括标签，内容和状态（公或私）。每一条笔记显示所有的标签和最多两行的内容，每个标签之间有固定的间距和行距。点击笔记进入编辑页面，可对内容进行更新。左滑笔记可以删除，并用气泡提示删除是否成功。
- **笔记编辑模块**的主要需求是，根据用户的输入显示标签，如输入aa/bb，显示两个标签aa bb。标签显示栏默认显示两行，超过两行更新高度。当标签和内容都有输入时，可保存或者更新笔记。
- **笔记搜索模块**的主要需求是，监听用户的输入，当用户的输入在300m后无变化时，请求服务器返回搜索结果，以列表的形式显示，并对搜索结果中的关键词进行高亮。 搜索结果可点击，如果是我的笔记，则进入笔记编辑页面，如果是别人的笔记，进入显示页面，不可编辑。
- **其他UI细节**的需求，比如nivagationvbar的样式，textfied的样式，UI的颜色字体等等。

# 难点

- 由于每一条笔记的内容不一致，所以需要解决tableview的高度自适应问题
- 原生searchBar的updateSearchResults代理方法没有防抖的机制，需要自定义。
- 对搜索结果进行关键词高亮，由于关键词可能在笔记内容的两行之后，所以需要先找到关键词，再显示关键词和它之后的内容，并高亮关键词。

# 解决方案

- tableview的高度自适应采用嵌套collectionViewCell的tableViewCell。首先通过collectionView的flowLayout代理方法计算cell的宽高。再自定义collectionView的flowLayout，通过重写layoutAttributesForElements实现cell的间距调整，然后从方法里获取最后一个cell的maxY得到collectionView的高度，以委托的设计模式将高度参数传递给tebleView, 由tableView决定高度的更新时机，最终实现高度自适应。
- GCD实现：将搜索请求放入dispatchWorkItem的闭包中，每当有新的请求就用cancel取消前一个item，新的item在dispatchqueue.main里延迟执行。
- 搜索关键词高亮，对于笔记内容，用滑动窗口匹配第一个出现的关键字，然后记录窗口左边的位置，再删除关键词之前的内容。通过富文本的方式实现关键词的高亮。